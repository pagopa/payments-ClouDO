<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8"/>
    <title>ClouDO Log</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <!--  <link rel="stylesheet" type="text/css" href="./global.css"/>-->
    <style>
        /* ===== Design Tokens (Dark Soft) ===== */
        :root{
          --radius:14px;

          /* Fondi e testi */
          --bg:#0b0f14;
          --panel:#12161d;
          --panel-2:#171c24;
          --text:#eef2f6;
          --muted:#a7b1bf;
          --border:#26303b;

          /* Colori stato/azione */
          --accent:#60a5fa;
          --ok:#22c55e;
          --warn:#f59e0b;
          --err:#ef4444;
        }

        /* ===== Base ===== */
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
          margin:0;
          background:
            radial-gradient(80vw 60vh at 5% -10%, rgba(96,165,250,.06), transparent 60%),
            radial-gradient(80vw 60vh at 105% 10%, rgba(34,197,94,.05), transparent 60%),
            linear-gradient(180deg, #0b0f14, #0e141b 55%, #0b0f14);
          color:var(--text);
          font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
          line-height:1.5;
        }

        /* Containers */
        .wrap{max-width:1100px;margin:0 auto}
        header.app{
          position:sticky; top:0; padding:18px 22px;
          background:rgba(18,22,29,.72); backdrop-filter: blur(8px);
          border-bottom:1px solid var(--border);
        }
        h1{margin:0 0 4px; font-size:22px}
        h2{margin:0; font-size:18px}
        h3{margin:0; font-size:16px}
        .muted{color:var(--muted); font-size:13px}

        /* Card */
        .grid{display:grid; gap:18px}
        .card{
          background:var(--panel);
          border:1px solid var(--border);
          border-radius:var(--radius);
          box-shadow:0 12px 28px rgba(0,0,0,.35);
          overflow:hidden;
        }
        .card>header{padding:18px;border-bottom:1px solid var(--border); background:linear-gradient(180deg, var(--panel-2), var(--panel))}
        .card>.content{padding:18px}

        /* Box, full-width for logs */
        .box{
          max-width:880px; margin:3rem auto; background:#ffffff; color:#0f172a;
          border:1px solid #e5e7eb; border-radius:14px; padding:26px;
          box-shadow: 0 12px 34px rgba(0,0,0,.10);
        }
        .box.logs{
          max-width:none; width:100%; margin:0; border-left:0; border-right:0; border-radius:0; padding:24px;
          background:transparent; color:var(--text); border-color:transparent; box-shadow:none;
        }

        /* Form */
        label{display:block; font-size:12px; color:var(--muted); margin:12px 0 6px}
        .input, textarea.input, select.input{
          width:100%; padding:12px 14px; border-radius:12px;
          border:1px solid var(--border); background:#0f141b; color:var(--text);
          outline:none; transition: box-shadow .15s ease,border-color .15s ease, background .2s ease;
        }
        .input::placeholder{color:#7f8a97}
        .input:focus{
          border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
          box-shadow:0 0 0 3px color-mix(in srgb, var(--accent) 22%, transparent);
          background:#111824;
        }
        textarea.input{min-height:110px; resize:vertical}
        .row{display:flex; gap:14px}.row>*{flex:1}

        /* Buttons */
        .btn{
          display:inline-flex; align-items:center; gap:.5rem;
          border-radius:12px; padding:10px 14px; font-weight:700;
          border:1px solid var(--border); background:transparent; color:var(--text);
          cursor:pointer; transition: transform .04s ease, filter .2s ease, background .2s ease, border-color .2s ease;
        }
        .btn:active{ transform: translateY(1px) }
        .btn-primary{
          background:linear-gradient(90deg, color-mix(in srgb, var(--accent) 70%, #3b82f6), var(--accent));
          color:#08111b; border:0
        }
        .btn-primary:hover{ filter:brightness(1.07) }
        .btn-ghost{
          background:rgba(167,177,191,.12); border:1px solid var(--border); color:var(--text)
        }
        .btn-ghost:hover{ background:rgba(167,177,191,.20) }
        .btn-warn{
          background:linear-gradient(90deg, #f59e0b, var(--warn)); color:#0b0f14; border:0
        }
        .btn-warn:hover{ filter:brightness(1.06) }

        /* Tables */
        .table-wrap{overflow:auto; border:1px solid var(--border); border-radius:12px}
        .table{ width:100%; border-collapse:separate; border-spacing:0 }
        .table thead th{
          position:sticky; top:0; z-index:2; background:var(--panel-2);
          color:var(--muted); font-weight:600; font-size:13px;
          border-bottom:1px solid var(--border);
        }
        .table th,.table td{ padding:12px 12px; font-size:14px; text-align:left; vertical-align:top; }
        .table tbody tr{ border-bottom:1px solid var(--border) }
        .table tbody tr:hover td{ background: color-mix(in srgb, var(--accent) 7%, transparent) }
        .table td.actions{ text-align:right; white-space:nowrap }

        /* Flex Table (responsive a tutta larghezza) */
        .flex-table{display:flex; flex-direction:column; gap:8px; width:100%}
        .flex-table .ft-head{
          display:grid; grid-template-columns: 160px 110px 330px 1fr 140px 2fr 120px auto; gap:12px; align-items:center;
          padding:10px 12px; background: linear-gradient(180deg, var(--panel-2), var(--panel));
          border:1px solid var(--border); border-radius:10px; position:sticky; top:0; z-index:2;
        }
        .flex-table .ft-row{
          display:grid; grid-template-columns: 160px 110px 330px 1fr 140px 2fr 120px auto; gap:12px; align-items:center;
          padding:12px; border:1px solid var(--border); border-radius:12px;
          background: linear-gradient(180deg, var(--panel), #0f141b);
        }
        .flex-table .ft-row:hover{ background: color-mix(in srgb, var(--accent) 8%, transparent) }
        .flex-table .ft-cell{min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
        .flex-table .ft-cell.shrink{white-space:nowrap}
        .flex-table .ft-cell.xs{/* gestito da grid */}
        .flex-table .ft-cell.lg{/* gestito da grid */}
        .flex-table .ft-cell.actions{display:flex; justify-content:flex-end; gap:6px; overflow:visible}
        .ft-head .lbl{color:var(--muted); font-weight:600; font-size:13px}

        /* Mobile stacking */
        @media (max-width: 1024px){
          .flex-table .ft-head{display:none}
          .flex-table .ft-row{display:flex; flex-direction:column; gap:6px}
          .flex-table .ft-cell.actions{justify-content:flex-start}
        }

        /* Badge and status */
        .code{ background: rgba(167,177,191,.16); color: var(--text); padding:2px 8px; border-radius:8px }
        .status{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700 }
        .status-running{   background: color-mix(in srgb, var(--accent) 20%, transparent); color: var(--accent) }
        .status-completed{ background: color-mix(in srgb, var(--ok) 18%, transparent);     color: var(--ok) }
        .status-failed{    background: color-mix(in srgb, var(--err) 20%, transparent);    color: var(--err) }
        .status-stopped{   background: color-mix(in srgb, var(--warn) 18%, transparent);   color: var(--warn) }

        /* Pre/log */
        pre.log{
          background:#0f141b; color:#eef2f6; border:1px solid var(--border);
          border-radius:12px; padding:14px; overflow:auto; white-space:pre-wrap
        }

        .grid-approval{ display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:14px; margin-top:14px }
        .kv{ border:1px solid #e5e7eb; border-radius:12px; padding:12px 14px; background:#fff }
        .kv .k{ display:block; font-size:.82rem; color:#6b7280; margin-bottom:6px }
        .kv .v{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; word-break: break-all }

        .badge{ display:inline-block; padding:4px 12px; border-radius:999px; font-size:.8rem; border:1px solid #e5e7eb }
        .badge-ok{ background:#ecfdf5; color:#166534; border-color:#bbf7d0 }
        .badge-warn{ background:#fffbeb; color:#92400e; border-color:#fde68a }
        .badge-err{ background:#fef2f2; color:#b91c1c; border-color:#fecaca }

        .actions .btn{ padding:8px 12px; border-radius:10px }
        .actions .btn + .btn{ margin-left:6px }

        /* Modal (Logs) */
        .modal{
          position:fixed; inset:0; display:none; align-items:center; justify-content:center;
          background:rgba(0,0,0,.55); z-index:1000;
        }
        .modal.open{ display:flex }
        .modal-content{
          background:var(--panel); color:var(--text);
          width:min(90vw,1100px); max-height:85vh; overflow:auto;
          border:1px solid var(--border); border-radius:14px; box-shadow:0 20px 50px rgba(0,0,0,.5);
        }
        .modal-header{
          display:flex; align-items:center; justify-content:space-between;
          padding:14px 16px; border-bottom:1px solid var(--border); background:var(--panel-2);
        }
        .modal-title{ font-weight:700 }
        .modal-body{ padding:14px 16px }
        .modal-close{
          background:transparent; border:1px solid var(--border); color:var(--text);
          border-radius:10px; padding:6px 10px; cursor:pointer;
        }
        .modal-close:hover{ background:rgba(167,177,191,.20) }

        /* Helpers */
        .nowrap{ white-space:nowrap }
    </style>
</head>
<body>
<div class="box logs">
    <h1>ClouDO Log</h1>
    <p class="muted">Interroga la tabella RunbookLogs. Suggerimento: PartitionKey tipicamente è la data YYYYMMDD.</p>

    <div class="grid" style="grid-template-columns: repeat(12, minmax(0,1fr)); gap:12px">
        <div style="grid-column: span 3;">
            <label for="partitionKey">PartitionKey</label>
            <input id="partitionKey" class="input" placeholder="es. 20251001"/>
        </div>
        <div style="grid-column: span 3;">
            <label for="execId">ExecId</label>
            <input id="execId" class="input" placeholder="UUID esatto (opzionale)"/>
        </div>
        <div style="grid-column: span 2;">
            <label for="status">Status</label>
            <select id="status" class="input">
                <option value="">All</option>
                <option value="accepted">accepted</option>
                <option value="succeeded">succeeded</option>
                <option value="running">running</option>
                <option value="failed">failed</option>
                <option value="error">error</option>
            </select>
        </div>
        <div style="grid-column: span 4;">
            <label for="q">Testo (Name/Id/Runbook/Url/Log)</label>
            <input id="q" class="input" placeholder="contains... (case-insensitive)"/>
        </div>
        <div style="grid-column: span 3;">
            <label for="from">Da (RequestedAt)</label>
            <input id="from" class="input" type="datetime-local"/>
        </div>
        <div style="grid-column: span 3;">
            <label for="to">A (RequestedAt)</label>
            <input id="to" class="input" type="datetime-local"/>
        </div>
        <div style="grid-column: span 1;">
            <label for="limit">Limite</label>
            <input id="limit" class="input" type="number" min="1" max="5000" value="200"/>
        </div>
        <div style="grid-column: span 2;">
            <label for="order">Ordine</label>
            <select id="order" class="input">
                <option value="desc">RequestedAt desc</option>
                <option value="asc">RequestedAt asc</option>
            </select>
        </div>
        <div style="grid-column: span 3; display:flex; align-items:flex-end; gap:8px">
            <button id="run" class="btn btn-primary" type="button">
                <span style="display:inline-block;width:0;height:0;border-left:8px solid currentColor;border-top:6px solid transparent;border-bottom:6px solid transparent;margin-right:6px;vertical-align:middle;"></span>
                Run
            </button>
            <button id="clear" class="btn btn-ghost" type="button">Reset</button>

            <button id="openProcessModal" class="btn btn-ghost" type="button" title="Visualizza processi attivi">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
                Processes
            </button>
        </div>

        <div style="grid-column: span 12;">
            <span id="info" class="muted" aria-live="polite"></span>
        </div>
    </div>

    <div id="logModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Log</div>
                <button class="modal-close" onclick="closeLogModal()" aria-label="Chiudi">Chiudi</button>
            </div>
            <div class="modal-body">
                <pre id="logContent" class="log"></pre>
            </div>
        </div>
    </div>

    <div id="processModal" class="modal">
        <div class="modal-content" style="width: min(95vw, 1400px);">
            <div class="modal-header">
                <div class="modal-title">Processi del worker</div>
                <button class="modal-close" onclick="closeProcessModal()" aria-label="Chiudi">Chiudi</button>
            </div>
            <div class="modal-body">
                <form id="processForm">
                    <div class="row">
                        <div>
                            <label for="processWorkerSelect">Seleziona Worker</label>
                            <select id="processWorkerSelect" class="input" required>
                                <option value="" disabled selected>-- Scegli un worker --</option>
                            </select>
                        </div>
                    </div>

                    <p class="muted" style="margin-top:8px">
                        Seleziona un worker dalla lista. Verrà effettuata una richiesta proxy dal backend verso il worker indicato per recuperare l'elenco dei processi attivi.
                    </p>

                    <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:8px">
                        <button type="button" class="btn btn-ghost" onclick="closeProcessModal()">Chiudi</button>
                        <button id="processSubmit" type="submit" class="btn btn-primary">Carica lista</button>
                    </div>

                    <div id="processResult" style="margin-top:10px; font-size:0.9rem; overflow:auto"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tabella flex full-width -->
    <details open style="margin-top:14px">
        <summary>Risultati</summary>
        <div id="ft" class="flex-table" style="margin-top:12px; width:100%;">
            <div class="ft-head">
                <div class="ft-cell lbl xs">RequestedAt</div>
                <div class="ft-cell lbl xs">Status</div>
                <div class="ft-cell lbl">ExecId</div>
                <div class="ft-cell lbl">Name</div>
                <div class="ft-cell lbl xs">Id</div>
                <div class="ft-cell lbl">Runbook</div>
                <div class="ft-cell lbl xs">Condition</div>
                <div class="ft-cell lbl shrink">Azioni</div>
            </div>
        </div>
    </details>

    <details style="margin-top:10px">
        <summary>JSON raw</summary>
        <pre id="raw" class="log"></pre>
    </details>
</div>

<script>
    const FUNCTION_QUERY_CODE = {raw:code_js};
    const WORKERS_LIST = {raw:workers};
    const el = id => document.getElementById(id);

    (function(){
        const sel = document.getElementById('processWorkerSelect');
        if(sel) {
            sel.innerHTML = '';

            if(Array.isArray(WORKERS_LIST) && WORKERS_LIST.length > 0){
                const allOpt = document.createElement('option');
                allOpt.value = "__ALL__";
                allOpt.textContent = `Tutti i worker (${WORKERS_LIST.length})`;
                allOpt.style.fontWeight = "bold";
                sel.appendChild(allOpt);

                const sep = document.createElement('option');
                sep.disabled = true;
                sep.textContent = "──────────";
                sel.appendChild(sep);

                WORKERS_LIST.forEach(w => {
                    const opt = document.createElement('option');
                    opt.value = w;
                    opt.textContent = w;
                    sel.appendChild(opt);
                });

                sel.value = "__ALL__";
            } else {
                const opt = document.createElement('option');
                opt.disabled = true;
                opt.textContent = "(Nessun worker attivo)";
                sel.appendChild(opt);
            }
        }
    })();

    console.log(WORKERS_LIST)
    function esc(s){
      return (''+s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    function decodeNewlines(s) {
      try { return JSON.parse('"' + String(s).replace(/\\/g, '\\\\').replace(/"/g, '\\"') + '"'); }
      catch (_) { return String(s).replace(/\\r\\n/g, '\n').replace(/\\n/g, '\n').replace(/\\t/g, '\t'); }
    }

    function rowBadge(st){
      const s = String(st||'').toLowerCase();
      if (s === 'succeeded' || s === 'completed') return '<span class="status status-completed">succeeded</span>';
      if (s === 'running') return '<span class="status status-running">running</span>';
      if (s === 'failed' || s === 'error') return '<span class="status status-failed">'+esc(st)+'</span>';
      if (s === 'stopped') return '<span class="status status-stopped">stopped</span>';
      if (s === 'accepted' || s === 'pending') return '<span class="status status-stopped">'+esc(st)+'</span>';
      return '<span class="status">'+esc(st)+'</span>';
    }

    function openOnlyLogModal(btn){
      const url = btn.getAttribute('data-url');
      const modal = document.getElementById('logModal');
      const pre = document.getElementById('logContent');
      pre.textContent = 'Caricamento...';
      modal.classList.add('open');
      fetch(url, { cache: 'no-store' })
        .then(r => r.text())
        .then(txt => {
          try {
            const data = JSON.parse(txt);
            const extractLog = (e) => (e && (e.Log ?? e.log ?? '')) || '';
            if (Array.isArray(data)) {
              const logs = data
                .sort((a,b) => (b.RequestedAt || '').localeCompare(a.RequestedAt || ''))
                .map(e => decodeNewlines(extractLog(e)))
                .filter(s => s && s.length > 0);
              pre.textContent = logs.length ? logs.join('\n\n---\n\n') : 'Nessun campo Log disponibile.';
            } else {
              const only = decodeNewlines(extractLog(data));
              pre.textContent = only ? only : 'Nessun campo Log disponibile.';
            }
          } catch(_){ pre.textContent = txt; }
        })
        .catch(err => { pre.textContent = 'Errore: ' + err.message; });
    }

    function openTraceModal(btn){
      const url = btn.getAttribute('data-url');
      const modal = document.getElementById('logModal');
      const pre = document.getElementById('logContent');
      pre.textContent = 'Caricamento...';
      modal.classList.add('open');
      fetch(url, { cache: 'no-store' })
        .then(r => r.text())
        .then(txt => {
          try { pre.textContent = JSON.stringify(JSON.parse(txt), null, 2); }
          catch(_){ pre.textContent = txt; }
        })
        .catch(err => { pre.textContent = 'Errore: ' + err.message; });
    }

    function closeLogModal(){
      const modal = document.getElementById('logModal');
      modal.classList.remove('open');
    }

    function openProcessModal(){
      const modal = document.getElementById('processModal');
      const result = document.getElementById('processResult');
      const submitBtn = document.getElementById('processSubmit');
      if (result) result.textContent = '';
      if (submitBtn) submitBtn.disabled = false;
      modal.classList.add('open');
    }

    function closeProcessModal(){
      const modal = document.getElementById('processModal');
      modal.classList.remove('open');
    }

    async function fetchWorkerProcesses(workerName) {
        let url = `/api/workers/processes?worker=${encodeURIComponent(workerName)}`;
        if (FUNCTION_QUERY_CODE) {
             url += `&code=${encodeURIComponent(FUNCTION_QUERY_CODE)}`;
        }
        try {
            const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const text = await res.text();
            let data;
            try { data = JSON.parse(text); } catch { data = text; }

            let list = [];
            if (Array.isArray(data)) list = data;
            else if (data && Array.isArray(data.runs)) list = data.runs;
            else if (data && Array.isArray(data.processes)) list = data.processes;

            return list.map(item => ({ ...item, _source_worker: workerName }));
        } catch (e) {
            console.warn(`Errore fetch worker ${workerName}:`, e);
            return [];
        }
    }

    async function submitProcessForm(ev){
      ev.preventDefault();

      const selectEl = document.getElementById('processWorkerSelect');
      const resultEl = document.getElementById('processResult');
      const submitBtn = document.getElementById('processSubmit');

      let selection = (selectEl?.value || '').trim();

      if (!selection){
        alert('Seleziona un opzione');
        return;
      }

      if (resultEl) resultEl.innerHTML = '<div class="muted">Caricamento processi...</div>';
      if (submitBtn) submitBtn.disabled = true;

      try {
        let workersToCall = [];

        if (selection === '__ALL__') {
            workersToCall = WORKERS_LIST;
        } else {
            workersToCall = [selection];
        }

        const promises = workersToCall.map(w => fetchWorkerProcesses(w));
        const results = await Promise.all(promises);

        const allProcesses = results.flat();

        if (allProcesses.length === 0) {
            if (resultEl) resultEl.innerHTML = '<div class="muted">Nessun processo trovato su ' + workersToCall.length + ' worker.</div>';
            return;
        }

        let html = `
        <div class="table-wrap">
            <table class="table" style="width:100%">
                <thead>
                    <tr>
                        <th>Worker</th> <!-- Nuova colonna -->
                        <th>ExecId</th>
                        <th>Name / ID</th>
                        <th>Runbook</th>
                        <th style="width:100px">Status</th>
                        <th style="width:160px; text-align:right">Started At</th>
                    </tr>
                </thead>
                <tbody>`;

        allProcesses.sort((a, b) => (a._source_worker || '').localeCompare(b._source_worker || ''));

        allProcesses.forEach(p => {
            const source = p._source_worker || '-';
            const execId = p.exec_id ?? '-';
            const name = p.name ?? '-';
            const id = p.id ?? '';
            const runbook = p.runbook ?? '-';
            const status = p.status ?? 'unknown';
            const started = p.startedAt ?? p.requestedAt ?? '-';

            let timeStr = esc(started).replace('T', ' ').split('.')[0];

            html += `
                <tr>
                    <td><span class="code" style="font-size:0.8em; color:var(--accent)">${esc(source)}</span></td>
                    <td><code class="code" style="font-size:0.85em">${esc(execId)}</code></td>
                    <td>
                        <div style="font-weight:600; color:var(--text)">${esc(name)}</div>
                        <div class="muted" style="font-size:0.8em">${esc(id)}</div>
                    </td>
                    <td><code class="code">${esc(runbook)}</code></td>
                    <td>${rowBadge(status)}</td>
                    <td class="muted" style="text-align:right; font-size:0.85em">${timeStr}</td>
                </tr>
            `;
        });

        html += `</tbody></table></div>`;
        html += `<div class="muted" style="margin-top:8px; font-size:0.8em; text-align:right">
            Processi totali: <strong>${allProcesses.length}</strong> su <strong>${workersToCall.length}</strong> worker
        </div>`;

        if (resultEl) resultEl.innerHTML = html;

      } catch(err) {
        console.error(err);
        if (resultEl) resultEl.innerHTML = `<div style="color:var(--err)">Errore JS: ${esc(err.message)}</div>`;
      } finally {
        if (submitBtn) submitBtn.disabled = false;
      }
    }

    document.addEventListener('keydown', (e) => {

      if (e.key === 'Escape'){
        closeLogModal();
        closeProcessModal();
      }
    });
    document.addEventListener('click', (e) => {
      const logModal = document.getElementById('logModal');
      const procModal = document.getElementById('processModal');
      if (logModal.classList.contains('open') && e.target === logModal) closeLogModal();
      if (procModal.classList.contains('open') && e.target === procModal) closeProcessModal();
    });

    async function runQuery(){
      const infoEl = el('info');
      if (infoEl) infoEl.textContent = 'Caricamento...';

      const params = new URLSearchParams();
      const pk = el('partitionKey').value.trim();
      if (!pk) { alert('PartitionKey è obbligatorio'); return; }
      params.set('partitionKey', pk);
      const execId = el('execId').value.trim(); if (execId) params.set('execId', execId);
      const status = el('status').value; if (status) params.set('status', status);
      const q = el('q').value.trim(); if (q) params.set('q', q);
      const f = el('from').value; if (f) params.set('from', f);
      const t = el('to').value; if (t) params.set('to', t);
      const limit = el('limit').value; if (limit) params.set('limit', limit);
      const order = el('order').value; if (order) params.set('order', order);
      if (FUNCTION_QUERY_CODE) params.set('code', FUNCTION_QUERY_CODE);

      const url = '/api/logs/query?' + params.toString();
      const res = await fetch(url);
      const data = await res.json().catch(() => ({ error: 'parse' }));
      const rawEl = el('raw'); if (rawEl) rawEl.textContent = JSON.stringify(data, null, 2);

      // Render flex table
      const ft = document.getElementById('ft');
      if (ft) ft.querySelectorAll('.ft-row').forEach(n => n.remove());

      if (!res.ok) {
        if (infoEl) infoEl.textContent = 'Errore: ' + ((data && data.error) || res.status);
        return;
      }

      (data.items || []).forEach(item => {
        const baseUrl = "/api/logs/" + esc(item.PartitionKey || "") + "/" + esc(item.ExecId || "");
        const urlWithCode = {raw:code_js} && {raw:code_js} !== ""
          ? baseUrl + "?code=" + encodeURIComponent({raw:code_js})
          : baseUrl;

        const row = document.createElement('div');
        row.className = 'ft-row';
        row.innerHTML = `
          <div class="ft-cell xs nowrap">${esc(item.RequestedAt || '')}</div>
          <div class="ft-cell xs">${rowBadge(item.Status || '')}</div>
          <div class="ft-cell"><code class="code">${esc(item.ExecId || '')}</code></div>
          <div class="ft-cell">${esc(item.Name || '')}</div>
          <div class="ft-cell xs">${esc(item.Id || '')}</div>
          <div class="ft-cell lg">${esc(item.Runbook || '')}</div>
          <div class="ft-cell xs">${esc(item.MonitorCondition || '')}</div>
          <div class="ft-cell actions shrink">
            <button class="btn btn-ghost" data-url="${urlWithCode}" onclick="openTraceModal(this)">Trace</button>
            <button class="btn btn-ghost" data-url="${urlWithCode}" onclick="openOnlyLogModal(this)">Log</button>
          </div>
        `;
        if (ft) ft.appendChild(row);
      });

      if (infoEl) infoEl.textContent = (data.items || []).length + ' risultato/i';
    }

    // Bind
    document.getElementById('run').addEventListener('click', runQuery);
    document.getElementById('clear').addEventListener('click', ()=>{
      ['partitionKey','execId','q','from','to'].forEach(id=>el(id).value='');
      el('status').value='';
      el('limit').value='200';
      el('order').value='desc';
      const ft = document.getElementById('ft'); if (ft) ft.querySelectorAll('.ft-row').forEach(n => n.remove());
      const rawEl = el('raw'); if (rawEl) rawEl.textContent='';
      const infoEl = el('info'); if (infoEl) infoEl.textContent='';
      setDefaultPartitionKey();
    });
    document.getElementById('openProcessModal').addEventListener('click', openProcessModal);
    document.getElementById('processForm').addEventListener('submit', submitProcessForm);

    function setDefaultPartitionKey(){
      const d = new Date(), pad = n => String(n).padStart(2,'0');
      const today = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
      const input = document.getElementById('partitionKey');
      if (input && !input.value) input.value = today;
    }
    setDefaultPartitionKey();
</script>
</body>
</html>
